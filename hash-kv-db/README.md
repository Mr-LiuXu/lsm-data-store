## HashKvDB
以哈希算法为基础的KV数据库，内存存放key和文件对应的position，文件存放对应的command log。实现的功能：

- 索引更新(内存)
- command log更新(WAL)
- log compact(COW)
- 索引恢复(从WAL日志进行恢复)

**当前实现哈希算法数据库的优缺点：**

哈希索引使用顺序写入的日志来追加式地记录每一个命令，看起来非常浪费存储空间：为什么不是直接原地更新文件，用新数据覆盖老数据呢？实际上追加式的设计是非常优秀的，主要原因有以下几个：：

- 追加式主要使用顺序写入，性能非常高，比起覆盖式的随机写入要快得多。
- 追加式的写入在处理并发和崩溃恢复时要简单得多，例如不需要担心在重写值时发生崩溃的情况，追加式写入时如果崩溃了，只需要丢弃文件末尾有问题的数据，而覆盖式更新崩溃，你都不知道哪些数据是脏数据。
- 追加式的日志写入可以通过合并旧的日志文件解决碎片化的问题。

缺点：

- 哈希索引的实现要求所有key都放到内存里面，如果有大量的key存在，那么就没办法处理了。理论上可以把索引放到磁盘上面，但是这样读取速度就会受到影响。
- 无法支持快速的区间查询，只能遍历一遍所有key。

**总结**

hashkvdb的实现其实性能非常高，WAL的写入是顺序的，每次读取其实只需要一次的随机文件IO。缺点是由于其存储的无序性决定了这个数据结构无法很好地支持scan的操作，并且由于索引是保存在内存的，所以存储的空间也是有限。哈希索引只是KV数据库的起步，后续我们还会看到解决哈希索引缺点的新索引结构（LSM-tree），这些索引设计的思想是很多先进KV数据库（如Hbase、Cassandra）的基石。

注：最简单的数据库实现

```
#!/bin/bash

db_set() {
        echo "$1,$2" >> database
}

db_get() {
        grep "^$1," database | sed -e "s/^$1,//" | tail -n 1
}
```


